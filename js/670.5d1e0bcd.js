"use strict";(self["webpackChunkvue3_ecommerce_pojui"]=self["webpackChunkvue3_ecommerce_pojui"]||[]).push([[670],{2289:function(t,e,a){a.r(e),a.d(e,{default:function(){return Lt}});var r=a(641),s=a(2644),d=a(9322);const l=(0,r.Lk)("i",{class:"fas fa-spinner fa-spin fa-5x"},null,-1),i={class:"table mt-4"},n=(0,r.Lk)("thead",{class:"table-dark"},[(0,r.Lk)("tr",null,[(0,r.Lk)("th",null,"購買時間"),(0,r.Lk)("th",null,"Email"),(0,r.Lk)("th",null,"訂單編號"),(0,r.Lk)("th",null,"應付金額"),(0,r.Lk)("th",null,"是否付款"),(0,r.Lk)("th",null,"編輯")])],-1),o=["textContent"],c=["textContent"],u={class:"text-left"},p={class:"form-check form-switch"},h=["id","onUpdate:modelValue","onChange"],k=["for"],m={key:0,class:"text-success"},L={key:1,class:"text-danger"},b={class:"btn-group"},f=["onClick"],g=["onClick"];function _(t,e,a,_,v,O){const y=(0,r.g2)("Loading"),C=(0,r.g2)("OrderModal"),x=(0,r.g2)("Pagination");return(0,r.uX)(),(0,r.CE)(r.FK,null,[(0,r.bF)(y,{active:v.isLoading},{default:(0,r.k6)((()=>[l])),_:1},8,["active"]),(0,r.Lk)("table",i,[n,(0,r.Lk)("tbody",null,[((0,r.uX)(!0),(0,r.CE)(r.FK,null,(0,r.pI)(v.ordersData,((e,a)=>((0,r.uX)(),(0,r.CE)(r.FK,{key:a},[v.orders.length?((0,r.uX)(),(0,r.CE)("tr",{key:0,class:(0,s.C4)({"text-secondary":!e.is_paid})},[(0,r.Lk)("td",null,(0,s.v_)(t.$filters.date(e.create_at)),1),(0,r.Lk)("td",null,[e.user?((0,r.uX)(),(0,r.CE)("span",{key:0,textContent:(0,s.v_)(e.user.email)},null,8,o)):(0,r.Q3)("",!0)]),(0,r.Lk)("td",null,[e?((0,r.uX)(),(0,r.CE)("span",{key:0,textContent:(0,s.v_)(e.id)},null,8,c)):(0,r.Q3)("",!0)]),(0,r.Lk)("td",u,(0,s.v_)(t.$filters.currency(e.cartTotal)),1),(0,r.Lk)("td",null,[(0,r.Lk)("div",p,[(0,r.bo)((0,r.Lk)("input",{class:"form-check-input",type:"checkbox",id:`paidSwitch${e.id}`,"onUpdate:modelValue":t=>e.is_paid=t,onChange:t=>O.updatePaid(e)},null,40,h),[[d.lH,e.is_paid]]),(0,r.Lk)("label",{class:"form-check-label",for:`paidSwitch${e.id}`},[e.is_paid?((0,r.uX)(),(0,r.CE)("span",m,"已付款")):((0,r.uX)(),(0,r.CE)("span",L,"未付款"))],8,k)])]),(0,r.Lk)("td",null,[(0,r.Lk)("div",b,[(0,r.Lk)("button",{class:"btn btn-outline-primary btn-sm",onClick:t=>O.openModal(!1,e)}," 檢視 ",8,f),(0,r.Lk)("button",{class:"btn btn-outline-danger btn-sm",onClick:t=>O.openDelOrderModal(e)}," 刪除 ",8,g)])])],2)):(0,r.Q3)("",!0)],64)))),128))])]),(0,r.bF)(C,{order:v.tempOrder,ref:"orderModal",onUpdateOrder:O.updateOrder},null,8,["order","onUpdateOrder"]),(0,r.bF)(x,{pages:v.pagination,onEmitPages:O.getOrders},null,8,["pages","onEmitPages"])],64)}const v=t=>((0,r.Qi)("data-v-462eeaf4"),t=t(),(0,r.jt)(),t),O={class:"modal fade",id:"productModal",tabindex:"-1",role:"dialog","aria-labelledby":"exampleModalLabel","aria-hidden":"true",ref:"modal"},y={class:"modal-dialog modal-xl",role:"document"},C={class:"modal-content border-0"},x=v((()=>(0,r.Lk)("div",{class:"modal-header bg-dark text-white"},[(0,r.Lk)("h5",{class:"modal-title",id:"exampleModalLabel"},[(0,r.Lk)("span",null,"訂單細節")]),(0,r.Lk)("button",{type:"button",class:"btn-close btn-close-white","data-bs-dismiss":"modal","aria-label":"Close"})],-1))),w={class:"modal-body"},E={class:"row"},D={class:"col-md-4"},$=v((()=>(0,r.Lk)("h3",{class:"inner-modal-title"},"◎ 用戶資料 ◎",-1))),X={class:"table"},M={key:0},P=v((()=>(0,r.Lk)("th",{style:{width:"100px"}},"姓名 :",-1))),I=v((()=>(0,r.Lk)("th",null,"Email :",-1))),T=v((()=>(0,r.Lk)("th",null,"電話 :",-1))),F=v((()=>(0,r.Lk)("th",null,"地址 :",-1))),A={class:"col-md-8"},G=v((()=>(0,r.Lk)("h3",{class:"inner-modal-title"},"◎ 訂單細節 ◎",-1))),j={class:"table"},B=v((()=>(0,r.Lk)("th",{style:{width:"100px"}},"訂單編號 :",-1))),H=v((()=>(0,r.Lk)("th",null,"下單時間 :",-1))),Q=v((()=>(0,r.Lk)("th",null,"付款時間 :",-1))),U={key:0},K={key:1,class:"text-warning"},Z=v((()=>(0,r.Lk)("th",null,"付款狀態 :",-1))),J={key:0,class:"text-success"},S={key:1,class:"text-danger"},N=v((()=>(0,r.Lk)("th",null,"優惠券 :",-1))),V={key:0,class:"text-success"},q={key:1,class:"text-danger"},z=v((()=>(0,r.Lk)("th",null,"總金額 :",-1))),R=v((()=>(0,r.Lk)("th",null,"留言 :",-1))),W=v((()=>(0,r.Lk)("h3",{class:"inner-modal-title"},"◎ 選購商品 ◎",-1))),Y={class:"table"},tt=v((()=>(0,r.Lk)("thead",null,[(0,r.Lk)("tr")],-1))),et={class:"text-end"},at={class:"modal-footer"},rt=v((()=>(0,r.Lk)("button",{type:"button",class:"btn btn-outline-secondary","data-bs-dismiss":"modal"}," 取消 ",-1)));function st(t,e,a,d,l,i){return(0,r.uX)(),(0,r.CE)("div",O,[(0,r.Lk)("div",y,[(0,r.Lk)("div",C,[x,(0,r.Lk)("div",w,[(0,r.Lk)("div",E,[(0,r.Lk)("div",D,[$,(0,r.Lk)("table",X,[l.tempOrder.user?((0,r.uX)(),(0,r.CE)("tbody",M,[(0,r.Lk)("tr",null,[P,(0,r.Lk)("td",null,(0,s.v_)(l.tempOrder.user.name),1)]),(0,r.Lk)("tr",null,[I,(0,r.Lk)("td",null,(0,s.v_)(l.tempOrder.user.email),1)]),(0,r.Lk)("tr",null,[T,(0,r.Lk)("td",null,(0,s.v_)(l.tempOrder.user.tel),1)]),(0,r.Lk)("tr",null,[F,(0,r.Lk)("td",null,(0,s.v_)(l.tempOrder.user.address),1)])])):(0,r.Q3)("",!0)])]),(0,r.Lk)("div",A,[G,(0,r.Lk)("table",j,[(0,r.Lk)("tbody",null,[(0,r.Lk)("tr",null,[B,(0,r.Lk)("td",null,(0,s.v_)(l.tempOrder.id),1)]),(0,r.Lk)("tr",null,[H,(0,r.Lk)("td",null,(0,s.v_)(t.$filters.date(l.tempOrder.create_at))+" "+(0,s.v_)(l.createDateDetail),1)]),(0,r.Lk)("tr",null,[Q,(0,r.Lk)("td",null,[""!==l.tempOrder.paid_date&&!0===l.tempOrder.is_paid?((0,r.uX)(),(0,r.CE)("span",U,(0,s.v_)(t.$filters.date(l.tempOrder.paid_date))+" "+(0,s.v_)(l.paidDateDetail),1)):((0,r.uX)(),(0,r.CE)("span",K,"時間不正確"))])]),(0,r.Lk)("tr",null,[Z,(0,r.Lk)("td",null,[l.tempOrder.is_paid?((0,r.uX)(),(0,r.CE)("strong",J,"已付款")):((0,r.uX)(),(0,r.CE)("span",S,"尚未付款"))])]),(0,r.Lk)("tr",null,[N,(0,r.Lk)("td",null,[!0===l.tempOrder.isCouponUsed?((0,r.uX)(),(0,r.CE)("strong",V,(0,s.v_)(l.tempOrder.products[0].coupon.title),1)):((0,r.uX)(),(0,r.CE)("span",q,"無"))])]),(0,r.Lk)("tr",null,[z,(0,r.Lk)("td",null,(0,s.v_)(t.$filters.currency(l.tempOrder.cartTotal)),1)]),(0,r.Lk)("tr",null,[R,(0,r.Lk)("td",null,(0,s.v_)(l.tempOrder.message),1)])])]),W,(0,r.Lk)("table",Y,[tt,(0,r.Lk)("tbody",null,[((0,r.uX)(!0),(0,r.CE)(r.FK,null,(0,r.pI)(l.tempOrder.products,(e=>((0,r.uX)(),(0,r.CE)("tr",{key:e.id},[(0,r.Lk)("th",null,"● "+(0,s.v_)(e.product.title),1),(0,r.Lk)("td",null,(0,s.v_)(e.qty)+" / "+(0,s.v_)(e.product.unit),1),(0,r.Lk)("td",et,(0,s.v_)(t.$filters.currency(e.final_total)),1)])))),128))])])])])]),(0,r.Lk)("div",at,[(0,r.Lk)("button",{type:"button",class:"btn btn-primary","data-bs-dismiss":"modal",onClick:e[0]||(e[0]=e=>t.$emit("update-order",l.tempOrder))}," 確認 "),rt])])])],512)}var dt=a(3286),lt={name:"orderModal",props:{order:{type:Object,default(){return{}}}},data(){return{status:{},modal:"",tempOrder:{},isPaid:!1,createDateDetail:"",paidDateDetail:""}},mixins:[dt.A],inject:["emitter"],watch:{order(){this.tempOrder=this.order,this.isPaid=this.tempOrder.is_paid,this.createDateDetail=this.formatTimestamp(this.tempOrder.create_at),this.paidDateDetail=this.formatTimestamp(this.tempOrder.paid_date)}},methods:{formatTimestamp(t){const e=new Date(1e3*t);return e.toLocaleTimeString()}}},it=a(6262);const nt=(0,it.A)(lt,[["render",st],["__scopeId","data-v-462eeaf4"]]);var ot=nt,ct=a(8285),ut=a(6723),pt=a(2541),ht=a(1884),kt={data(){return{orders:{},isNew:!1,pagination:{},isLoading:!1,tempOrder:{},currentPage:1,ordersData:{}}},components:{Pagination:ct.A,OrderModal:ot},methods:{updateOrder(t){console.log(t)},async getOrders(t=1){this.currentPage=t;const e=`https://vue3-course-api.hexschool.io/api/luxefume-api/admin/orders?page=${t}`;this.isLoading=!0,this.$http.get(e,this.tempProduct).then((t=>{console.log(t.data.pagination),this.orders=t.data.orders,this.pagination=t.data.pagination,this.isLoading=!1}));try{const e=(0,ht.rJ)(ut.db,"orderInfo"),a=await(0,ht.GG)(e),r=[];for(const t of a.docs){const e={id:t.id,...t.data()},a=(0,ht.rJ)(t.ref,"cartInfo"),s=await(0,ht.GG)(a),d=[];s.forEach((t=>{d.push({id:t.id,...t.data()})})),e.products=d,r.push(e)}this.ordersData=r;let s=t||1;const d=10,l=this.ordersData.length,i=Math.ceil(l/d);l<d&&(s=1,this.currentPage=s),s=Math.max(1,Math.min(s,i));const n=(s-1)*d,o=n+d;this.ordersData=this.ordersData.sort(((t,e)=>e.create_at-t.create_at));const c=this.ordersData.slice(n,o);this.ordersData=c}catch(a){console.error("Error fetching orders with subcollections: ",a)}},openModal(t,e){this.tempOrder={...e},this.isNew=!1;const a=this.$refs.orderModal;a.showModal()},openDelOrderModal(t){this.tempOrder={...t},this.$swal({title:"確定要刪除?",html:'是否刪除<b class="text-danger"></b>(刪除後將無法恢復)',icon:"warning",showCancelButton:!0,confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",confirmButtonText:"是, 確定刪除!",cancelButtonText:"取消"}).then((e=>{e.isConfirmed&&(this.$swal("已刪除!","檔案已被刪除","success"),this.delOrder(t.id))}))},async updatePaid(t){const e=(0,ht.H9)(ut.db,"orderInfo",t.id);let a="";this.ordersData.forEach((e=>{e.id===t.id&&!0===e.is_member&&(a=(0,ht.H9)(ut.db,"userInfo",e.uid))}));const r=await(0,ht.x7)(a),s=r.data();""!==a&&(s.orders.forEach((e=>{e.orderId===t.id&&(e.is_paid=t.is_paid,!1===t.is_paid&&(e.paid_date=""))})),await(0,ht.mZ)(a,{orders:s.orders})),!1===t.is_paid&&await(0,ht.mZ)(e,{paid_date:""}),await(0,ht.mZ)(e,{is_paid:t.is_paid}),this.isLoading=!0;const d=`https://vue3-course-api.hexschool.io/api/luxefume-api/admin/order/${t.id}`,l={is_paid:t.is_paid};this.$http.put(d,{data:l}).then((t=>{t.data.success&&(pt.A.fire({icon:"success",title:"付款狀態已更新"}),this.isLoading=!1,this.getOrders(this.currentPage))})).catch((()=>{this.isLoading=!1,pt.A.fire({icon:"error",title:"付款狀態更新失敗"})}))},async delOrder(t){const e=`https://vue3-course-api.hexschool.io/api/luxefume-api/admin/order/${this.tempOrder.id}`;this.isLoading=!0;const a=(0,ht.H9)(ut.db,"orderInfo",t);let r="";this.ordersData.forEach((e=>{e.id===t&&!0===e.is_member&&(r=(0,ht.H9)(ut.db,"userInfo",e.uid))}));const s=await(0,ht.x7)(r),d=s.data().orders;d.forEach((e=>{e.orderId===t&&d.splice(d.indexOf(e),1)})),await(0,ht.mZ)(r,{orders:d});const l=(0,ht.rJ)(a,"cartInfo"),i=await(0,ht.GG)(l);i.forEach((async t=>{await(0,ht.kd)(t.ref)})),await(0,ht.kd)(a),this.$http.delete(e).then((t=>{console.log(t),this.getOrders(this.currentPage)}))}},created(){this.getOrders(),this.$emitter.emit("check-navbar","orders")}};const mt=(0,it.A)(kt,[["render",_]]);var Lt=mt}}]);
//# sourceMappingURL=670.5d1e0bcd.js.map